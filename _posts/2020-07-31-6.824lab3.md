---
layout: post
title: "6.824lab3解题"
date: 2020-08-01 09:30
categories: "6.824"
tags:
    - distribution
    - algorithm
---

Lab3的实验主题是基于Raft协议的k/v服务的实现，并且继续Raft论文后半部分关于Snapshot的实现。 
6.824-2020 ， 
Lab3A: Key/value service without log compaction ， 
Lab3B: Key/value service with log compaction。

## 前言

Lab3的实验主题是基于Raft协议的k/v服务的实现，并且继续Raft论文后半部分关于Snapshot的实现。

本文打算把实验的设计用语言描述，以及总结一些注意事项。

先上实验结果，欢迎讨论。

```text
Test: one client (3A) ...
  ... Passed --  15.1  5  7748  718
Test: many clients (3A) ...
  ... Passed --  15.4  5 24607 3224
Test: unreliable net, many clients (3A) ...
  ... Passed --  16.1  5  8420 1260
Test: concurrent append to same key, unreliable (3A) ...
  ... Passed --   0.9  3   214   52
Test: progress in majority (3A) ...
  ... Passed --   0.3  5    42    2
Test: no progress in minority (3A) ...
  ... Passed --   1.1  5   121    3
Test: completion after heal (3A) ...
  ... Passed --   1.0  5    67    3
Test: partitions, one client (3A) ...
  ... Passed --  22.5  5 12433  510
Test: partitions, many clients (3A) ...
  ... Passed --  23.0  5 65133 2335
Test: restarts, one client (3A) ...
  ... Passed --  19.5  5 15759  713
Test: restarts, many clients (3A) ...
  ... Passed --  19.0  5 55188 3159
Test: unreliable net, restarts, many clients (3A) ...
  ... Passed --  20.5  5  9087 1260
Test: restarts, partitions, many clients (3A) ...
  ... Passed --  26.4  5 48869 1785
Test: unreliable net, restarts, partitions, many clients (3A) ...
  ... Passed --  27.5  5  7009  698
Test: unreliable net, restarts, partitions, many clients, linearizability checks (3A) ...
  ... Passed --  25.3  7 17666 1276
Test: InstallSnapshot RPC (3B) ...
  ... Passed --   4.2  3  3291   63
Test: snapshot size is reasonable (3B) ...
  ... Passed --  17.3  3  5666  800
Test: restarts, snapshots, one client (3B) ...
  ... Passed --  19.8  5 19744  708
Test: restarts, snapshots, many clients (3B) ...
  ... Passed --  20.0  5 92609 10392
Test: unreliable net, snapshots, many clients (3B) ...
  ... Passed --  16.2  5  8592 1270
Test: unreliable net, restarts, snapshots, many clients (3B) ...
  ... Passed --  19.8  5  8894 1247
Test: unreliable net, restarts, partitions, snapshots, many clients (3B) ...
  ... Passed --  27.8  5  7799  899
Test: unreliable net, restarts, partitions, snapshots, many clients, linearizability checks (3B) ...
  ... Passed --  25.3  7 20073 1563
PASS
ok  	6.824/src/kvraft	384.614s

```

## 代码设计

1. k/v Service设计：
参考课程小结，[duplicate RPC detection][1]

client开始执行指令（Get/PutAppend），将指令发送给server，直到成功收到server的返回。
这么做的目的是，一个client一次只能发一个指令。

如果client未收到响应，将会重发指令，但这个未收到，有两种情况
- 网络丢包，请求未送达server
- server已处理，网络丢包，响应未送达client

这两种情况客户端是识别不出来的，所以请求报文加了clientID、seq#，标识请求的唯一性

直到成功是什么呢？
- 如果由于网络问题，调用失败，发送相同报文，给下一台server
- 如果server不是leader，发送相同报文，给下一台server
- 成功收到leader的响应，则返回

不断的重复这个过程，重试所有的server。

2. Snapshot设计：


### Get/PutAppend的实现

server处理

### server的Snapshot实现


## 注意事项

- kv.mu和rf.mu不要嵌套着锁。
- 建议对每个if语句都排查一下，是否需要再考虑else的情况。
- kvServer的数据序列化，encode错误
    - StartKVServer函数开头部分已经说明了
    - 加代码`labgob.Register(map[string]string{})`
- 优雅的关闭
    - 有些任务判断Killed()，即可退出，比如超时选举任务
    - kvServer的ApplyLoop，即使关闭时，依然卡在applyCh的数据接收的位置
        - 给applyCh发特殊的ApplyMsg，代表关闭。谁发这个ApplyMsg？
        - 现在的ApplyMsg都是谁发的？Raft的ApplyLoop。
        - applyCh的发送和接收都会hold住，所以发送和接收要配对，
        才不会导致另一方卡住，所以也要由Raft的ApplyLoop发关闭的ApplyMsg




[1]: https://pdos.csail.mit.edu/6.824/notes/l-raft2.txt















